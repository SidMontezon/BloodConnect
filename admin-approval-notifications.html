<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Approval Notifications - BloodConnect Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="red-cross-styles.css">
</head>
<body>
    <header class="red-cross-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <a href="admin.html" class="red-cross-logo">
                    <div class="red-cross-icon">âœš</div>
                    <div>
                        <h1 class="red-cross-brand">BloodConnect</h1>
                        <p class="red-cross-tagline">Medical Blood Management</p>
                    </div>
                </a>
                <div class="red-cross-nav">
                    <a href="admin.html">Admin Panel</a>
                    <button id="logoutBtn" class="btn-red-cross-outline" style="border:none; background:transparent; cursor:pointer;">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container py-5">
        <div class="red-cross-page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="red-cross-page-title">Approval Notifications</h1>
                    <p class="red-cross-page-subtitle">Review and manage all pending approvals and notifications</p>
                </div>
                <a href="admin.html" class="btn-red-cross-outline">
                    <i class="fa-solid fa-arrow-left me-2"></i>Back to Admin Panel
                </a>
            </div>
        </div>

        <!-- Filter Tabs -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                    <i class="fa-solid fa-clock me-2"></i>Pending Approvals
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">
                    <i class="fa-solid fa-list me-2"></i>All Notifications
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <div class="tab-pane fade show active" id="pending" role="tabpanel">
                <div class="red-cross-card">
                    <div class="red-cross-card-header">
                        <i class="fa-solid fa-bell text-red-cross"></i>
                        Pending Approvals
                    </div>
                    <div class="red-cross-card-body">
                        <div id="pendingApprovals">
                            <div class="text-center py-4">
                                <div class="spinner-border text-red-cross" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="all" role="tabpanel">
                <div class="red-cross-card">
                    <div class="red-cross-card-header">
                        <i class="fa-solid fa-bell text-red-cross"></i>
                        All Notifications
                    </div>
                    <div class="red-cross-card-body">
                        <div id="allNotifications">
                            <div class="text-center py-4">
                                <div class="spinner-border text-red-cross" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import authManager from './auth-manager.js';
        import bloodConnectDB from './bloodConnectDB.js';

        authManager.addAuthListener(async (user, userData) => {
            if (user) {
                loadNotifications();
            }
        });

        async function loadNotifications() {
            try {
                const notifications = await bloodConnectDB.getNotifications ? await bloodConnectDB.getNotifications() : {};
                const users = await bloodConnectDB.getUsers();
                
                // Separate pending and all notifications
                const pendingNotifications = Object.entries(notifications || {})
                    .map(([id, notif]) => ({ id, ...notif }))
                    .filter(notif => 
                        notif && (notif.type === 'verification' || notif.type === 'registration' || notif.type === 'eligibility') &&
                        notif.status === 'pending'
                    )
                    .sort((a, b) => new Date((b.createdAt || 0)) - new Date((a.createdAt || 0)));

                const allNotificationsList = Object.entries(notifications || {})
                    .map(([id, notif]) => ({ id, ...notif }))
                    .sort((a, b) => new Date((b.createdAt || 0)) - new Date((a.createdAt || 0)));

                displayPendingApprovals(pendingNotifications, users);
                displayAllNotifications(allNotificationsList, users);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        function displayPendingApprovals(notifications, users) {
            const container = document.getElementById('pendingApprovals');
            if (!container) return;
            
            if (!notifications || notifications.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4">No pending approvals</div>';
                return;
            }

            container.innerHTML = '';
            notifications.forEach(notif => {
                if (!notif) return;
                const user = users[notif.userId] || {};
                const userName = user.firstName && user.lastName ? 
                    `${user.firstName} ${user.lastName}` : 
                    user.email || 'Unknown User';

                const notificationCard = document.createElement('div');
                notificationCard.className = 'red-cross-card mb-3';
                notificationCard.innerHTML = `
                    <div class="red-cross-card-body">
                        <h6 class="mb-2">${notif.title || 'Pending Approval'}</h6>
                        <p class="mb-2">${notif.message || ''}</p>
                        <small class="text-muted">
                            <strong>User:</strong> ${userName} | 
                            <strong>Type:</strong> ${notif.type || 'N/A'} | 
                            <strong>Date:</strong> ${notif.createdAt ? new Date(notif.createdAt).toLocaleString() : 'N/A'}
                        </small>
                        <div class="mt-3">
                            ${notif.type === 'registration' ? 
                                `<button class="btn btn-sm btn-success me-2" onclick="window.approveNotification('${notif.id}', '${notif.userId}', '${notif.type}')">
                                    <i class=\"fa-solid fa-check me-1\"></i>Approve
                                </button>
                                <button class=\"btn btn-sm btn-danger\" onclick=\"window.rejectNotification('${notif.id}', '${notif.userId}', '${notif.type}')\">\n                                    <i class=\"fa-solid fa-times me-1\"></i>Reject\n                                </button>` :
                                ''
                            }\n                        </div>\n                    </div>\n                `;\n                container.appendChild(notificationCard);\n            });\n        }\n\n        function displayAllNotifications(notifications, users) {\n            const container = document.getElementById('allNotifications');\n            if (!container) return;\n            \n            if (!notifications || notifications.length === 0) {\n                container.innerHTML = '<div class=\"text-center text-muted py-4\">No notifications</div>';\n                return;\n            }\n\n            container.innerHTML = '';\n            notifications.forEach(notif => {\n                if (!notif) return;\n                const user = users[notif.userId] || {};\n                const userName = user.firstName && user.lastName ? \n                    `${user.firstName} ${user.lastName}` : \n                    user.email || 'Unknown User';\n\n                const statusClass = notif.status === 'approved' ? 'success' : \n                                   notif.status === 'rejected' ? 'danger' : 'warning';\n\n                const notificationCard = document.createElement('div');\n                notificationCard.className = 'red-cross-card mb-3';\n                notificationCard.innerHTML = `\n                    <div class=\"red-cross-card-body\">\n                        <div class=\"d-flex justify-content-between align-items-start\">\n                            <div>\n                                <h6 class=\"mb-2\">${notif.title || 'Notification'}</h6>\n                                <p class=\"mb-2\">${notif.message || ''}</p>\n                                <small class=\"text-muted\">\n                                    <strong>User:</strong> ${userName} | \n                                    <strong>Type:</strong> ${notif.type || 'N/A'} | \n                                    <strong>Date:</strong> ${notif.createdAt ? new Date(notif.createdAt).toLocaleString() : 'N/A'}\n                                </small>\n                            </div>\n                            <span class=\"badge bg-${statusClass}\">${notif.status || 'pending'}</span>\n                        </div>\n                    </div>\n                `;\n                container.appendChild(notificationCard);\n            });\n        }\n\n        window.approveNotification = async function(notificationId, userId, type) {\n            if (!confirm('Are you sure you want to approve this request?')) return;\n\n            try {\n                // Update notification status\n                await bloodConnectDB.createNotification({\n                    userId: userId,\n                    type: 'system',\n                    title: 'Request Approved',\n                    message: `Your ${type} request has been approved.`,\n                    priority: 'high',\n                    createdAt: new Date().toISOString()\n                });\n\n                alert('Request approved successfully!');\n                loadNotifications();\n            } catch (error) {\n                console.error('Error approving notification:', error);\n                alert('Error approving request. Please try again.');\n            }\n        };\n\n        window.rejectNotification = async function(notificationId, userId, type) {\n            const reason = prompt('Please provide a reason for rejection:');\n            if (!reason || reason.trim() === '') {\n                alert('Reason is required.');\n                return;\n            }\n\n            try {\n                // Create rejection notification\n                await bloodConnectDB.createNotification({\n                    userId: userId,\n                    type: 'system',\n                    title: 'Request Rejected',\n                    message: `Your ${type} request has been rejected. Reason: ${reason}`,\n                    priority: 'high',\n                    createdAt: new Date().toISOString()\n                });\n\n                alert('Request rejected.');\n                loadNotifications();\n            } catch (error) {\n                console.error('Error rejecting notification:', error);\n                alert('Error rejecting request. Please try again.');\n            }\n        };\n\n        // Handle logout button\n        document.addEventListener('click', (e) => {\n            if (e.target && e.target.id === 'logoutBtn') {\n                e.preventDefault();\n                authManager.logoutAndRedirect();\n            }\n        });\n    </script>
</body>
</html>

