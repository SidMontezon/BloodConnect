<!DOCTYPE html>
<html lang="en">
<head>
    <title>BloodConnect - 2FA Verification</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .verification-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
        }
        .verification-box { 
            background: white; 
            padding: 40px; 
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: center; 
            width: 100%; 
            max-width: 400px; 
        }
        .error-message {
            color: red;
            margin-top: 10px;
        }
        .success-message {
            color: green;
            margin-top: 10px;
        }
        .verification-method {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .verification-method:hover {
            background-color: #f8f9fa;
            border-color: #dc3545;
        }
        .verification-method.active {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        .otp-input {
            font-size: 24px;
            text-align: center;
            letter-spacing: 10px;
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
        }
        .otp-input:focus {
            outline: none;
            border-color: #dc3545;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-dark bg-danger">
    <div class="container">
        <a class="navbar-brand" href="index.html"><i class="fa-solid fa-droplet"></i> BloodConnect</a>
    </div>
</nav>

<!-- 2FA Verification Form -->
<div class="verification-container">
    <div class="verification-box">
        <h2><i class="fa-solid fa-shield-halved"></i> Two-Factor Authentication</h2>
        <p class="text-muted">Please choose your verification method:</p>
        
        <!-- Verification Method Selection -->
        <div id="methodSelection">
            <div class="verification-method" onclick="selectMethod('sms')">
                <i class="fa-solid fa-mobile-screen"></i>
                <h5>SMS Verification</h5>
                <p class="mb-0">Receive a code via SMS</p>
            </div>
            <div class="verification-method" onclick="selectMethod('email')">
                <i class="fa-solid fa-envelope"></i>
                <h5>Email Verification</h5>
                <p class="mb-0">Receive a code via Email</p>
            </div>
        </div>

        <!-- Phone Number Input (for SMS) -->
        <div id="phoneInput" class="hidden">
            <h4>Enter your phone number</h4>
            <div class="input-group mb-3">
                <span class="input-group-text">+63</span>
                <input type="tel" id="phoneNumber" class="form-control" placeholder="9123456789" maxlength="10">
            </div>
            <button class="btn btn-danger w-100" onclick="sendSMSVerification()">
                <i class="fa-solid fa-paper-plane"></i> Send SMS Code
            </button>
        </div>

        <!-- Email Verification -->
        <div id="emailVerification" class="hidden">
            <h4>Email Verification</h4>
            <p>We'll send a verification code to your registered email.</p>
            <button class="btn btn-danger w-100" onclick="sendEmailVerification()">
                <i class="fa-solid fa-paper-plane"></i> Send Email Code
            </button>
        </div>

        <!-- OTP Input -->
        <div id="otpInput" class="hidden">
            <h4>Enter verification code</h4>
            <input type="text" id="otpCode" class="otp-input" placeholder="000000" maxlength="6">
            <button class="btn btn-danger w-100 mb-2" onclick="verifyOTP()">
                <i class="fa-solid fa-check"></i> Verify Code
            </button>
            <button class="btn btn-outline-secondary w-100" onclick="resendCode()">
                <i class="fa-solid fa-redo"></i> Resend Code
            </button>
        </div>

        <!-- Back to Login -->
        <div class="mt-3">
            <a href="login.html" class="text-danger">
                <i class="fa-solid fa-arrow-left"></i> Back to Login
            </a>
        </div>

        <!-- Error/Success Message Display -->
        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>
    </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyBElBKqa9ThPR1TbEXlCu-wGdi0vE943O4",
        authDomain: "bloodconnect2-d094a.firebaseapp.com",
        projectId: "bloodconnect2-d094a",
        storageBucket: "bloodconnect2-d094a.firebasestorage.app",
        messagingSenderId: "124251937624",
        appId: "1:124251937624:web:a69830e6bd3ab62e66a32d"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let selectedMethod = '';
    let confirmationResult = null;
    let verificationId = '';

    // Check if user is logged in and has pending verification
    window.addEventListener('load', function() {
        const pendingUser = sessionStorage.getItem('pendingUser');
        if (!pendingUser) {
            window.location.href = 'login.html';
        }
    });

    function selectMethod(method) {
        selectedMethod = method;
        
        // Update UI
        document.querySelectorAll('.verification-method').forEach(el => {
            el.classList.remove('active');
        });
        event.target.closest('.verification-method').classList.add('active');
        
        // Show appropriate input
        document.getElementById('methodSelection').classList.add('hidden');
        
        if (method === 'sms') {
            document.getElementById('phoneInput').classList.remove('hidden');
        } else if (method === 'email') {
            document.getElementById('emailVerification').classList.remove('hidden');
        }
    }

    function sendSMSVerification() {
        const phoneNumber = document.getElementById('phoneNumber').value;
        if (!phoneNumber || phoneNumber.length !== 10) {
            showError('Please enter a valid 10-digit phone number');
            return;
        }

        const fullPhoneNumber = '+63' + phoneNumber;
        
        // Create reCAPTCHA verifier
        const appVerifier = new firebase.auth.RecaptchaVerifier('phoneInput', {
            'size': 'invisible',
            'callback': function(response) {
                // reCAPTCHA solved, allow signInWithPhoneNumber
                console.log('reCAPTCHA solved');
            },
            'expired-callback': function() {
                // Response expired. Ask user to solve reCAPTCHA again.
                console.log('reCAPTCHA expired');
                showError('reCAPTCHA expired. Please try again.');
            }
        });

        // Clear any existing reCAPTCHA
        appVerifier.clear();

        auth.signInWithPhoneNumber(fullPhoneNumber, appVerifier)
            .then((confirmation) => {
                confirmationResult = confirmation;
                showSuccess('SMS verification code sent!');
                document.getElementById('phoneInput').classList.add('hidden');
                document.getElementById('otpInput').classList.remove('hidden');
            })
            .catch((error) => {
                console.error('SMS verification error:', error);
                if (error.code === 'auth/too-many-requests') {
                    showError('Too many requests. Please try again later.');
                } else if (error.code === 'auth/invalid-phone-number') {
                    showError('Invalid phone number format.');
                } else {
                    showError('Error sending SMS: ' + error.message);
                }
            });
    }

    function sendEmailVerification() {
        const pendingUser = JSON.parse(sessionStorage.getItem('pendingUser'));
        
        // Generate a random 6-digit code
        const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
        
        // Store the code in Firestore temporarily
        db.collection('verificationCodes').doc(pendingUser.uid).set({
            code: verificationCode,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            email: pendingUser.email
        }).then(() => {
            // Send email with verification code
            // Note: In a real application, you would use a backend service to send emails
            // For now, we'll simulate this by showing the code (remove in production)
            showSuccess('Verification code sent to your email: ' + verificationCode);
            document.getElementById('emailVerification').classList.add('hidden');
            document.getElementById('otpInput').classList.remove('hidden');
        }).catch((error) => {
            console.error('Error storing verification code:', error);
            showError('Error sending verification email: ' + error.message);
        });
    }

    function verifyOTP() {
        const otpCode = document.getElementById('otpCode').value;
        if (!otpCode || otpCode.length !== 6) {
            showError('Please enter a valid 6-digit code');
            return;
        }

        if (selectedMethod === 'sms') {
            verifySMSOTP(otpCode);
        } else if (selectedMethod === 'email') {
            verifyEmailOTP(otpCode);
        }
    }

    function verifySMSOTP(otpCode) {
        if (confirmationResult) {
            confirmationResult.confirm(otpCode)
                .then((result) => {
                    showSuccess('SMS verification successful!');
                    completeLogin();
                })
                .catch((error) => {
                    console.error('SMS verification error:', error);
                    showError('Invalid verification code');
                });
        } else {
            showError('No SMS verification in progress');
        }
    }

    function verifyEmailOTP(otpCode) {
        const pendingUser = JSON.parse(sessionStorage.getItem('pendingUser'));
        
        db.collection('verificationCodes').doc(pendingUser.uid).get()
            .then((doc) => {
                if (doc.exists) {
                    const storedCode = doc.data().code;
                    const timestamp = doc.data().timestamp;
                    const now = new Date();
                    const codeTime = timestamp.toDate();
                    const timeDiff = (now - codeTime) / 1000 / 60; // minutes
                    
                    if (timeDiff > 10) { // Code expires after 10 minutes
                        showError('Verification code has expired. Please request a new one.');
                        return;
                    }
                    
                    if (storedCode === otpCode) {
                        showSuccess('Email verification successful!');
                        // Delete the used code
                        db.collection('verificationCodes').doc(pendingUser.uid).delete();
                        completeLogin();
                    } else {
                        showError('Invalid verification code');
                    }
                } else {
                    showError('No verification code found. Please request a new one.');
                }
            })
            .catch((error) => {
                console.error('Error verifying email code:', error);
                showError('Error verifying code: ' + error.message);
            });
    }

    function resendCode() {
        if (selectedMethod === 'sms') {
            sendSMSVerification();
        } else if (selectedMethod === 'email') {
            sendEmailVerification();
        }
    }

    function completeLogin() {
        const pendingUser = JSON.parse(sessionStorage.getItem('pendingUser'));
        
        // Clear the pending user data
        sessionStorage.removeItem('pendingUser');
        
        // Redirect based on role
        if (pendingUser.role === "admin") {
            window.location.href = "dashboard.html";
        } else if (pendingUser.role === "user" || pendingUser.role === "donor") {
            window.location.href = "donatordashboard.html";
        } else if (pendingUser.role === "hospital") {
            window.location.href = "hospitaldashboard.html";
        } else {
            window.location.href = "index.html";
        }
    }

    function showError(message) {
        const errorElement = document.getElementById('error-message');
        const successElement = document.getElementById('success-message');
        errorElement.textContent = message;
        successElement.textContent = '';
        errorElement.style.display = 'block';
        successElement.style.display = 'none';
    }

    function showSuccess(message) {
        const errorElement = document.getElementById('error-message');
        const successElement = document.getElementById('success-message');
        successElement.textContent = message;
        errorElement.textContent = '';
        successElement.style.display = 'block';
        errorElement.style.display = 'none';
    }
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
