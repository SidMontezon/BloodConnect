<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Profile Verification - BloodConnect</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="red-cross-styles.css">
    <style>
        .verification-status {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .verification-status.pending {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .verification-status.approved {
            background-color: #d1e7dd;
            border-left: 4px solid #198754;
        }
        .verification-status.rejected {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .file-upload-area {
            border: 2px dashed #dc3545;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background-color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-upload-area:hover {
            background-color: #f8f9fa;
            border-color: #c82333;
        }
        .file-upload-area.dragover {
            background-color: #fff3f3;
            border-color: #dc3545;
        }
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            margin-top: 1rem;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- Red Cross Header -->
    <header class="red-cross-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <a href="index.html" class="red-cross-logo">
                    <div class="red-cross-icon">âœš</div>
                    <div>
                        <h1 class="red-cross-brand">BloodConnect</h1>
                        <p class="red-cross-tagline">Medical Blood Management</p>
                    </div>
                </a>
                <div class="red-cross-nav">
                    <a href="logout.html" class="btn-red-cross-outline">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Verification Section -->
    <section class="red-cross-hero">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="red-cross-card">
                        <div class="red-cross-card-header">
                            <i class="fa-solid fa-id-card text-red-cross"></i>
                            Profile Verification
                        </div>
                        <div class="red-cross-card-body">
                            <!-- Verification Status -->
                            <div id="verificationStatusContainer" style="display: none;">
                                <div class="verification-status" id="verificationStatus">
                                    <h5><i class="fa-solid fa-info-circle me-2"></i>Verification Status</h5>
                                    <p id="verificationStatusText"></p>
                                </div>
                            </div>

                            <!-- Verification Form -->
                            <div id="verificationForm">
                                <p class="text-medical mb-4">
                                    To ensure the safety and security of our blood donation system, please verify your identity by uploading a valid government-issued ID and proof of address. 
                                    Your documents will be reviewed by our admin team within 24-48 hours.
                                </p>

                                <form id="verificationFormElement">
                                    <!-- ID Upload -->
                                    <div class="red-cross-form-group mb-4">
                                        <label class="red-cross-form-label">
                                            <i class="fa-solid fa-id-card me-2"></i>
                                            Government Issued ID
                                        </label>
                                        <div class="file-upload-area" id="idUploadArea">
                                            <i class="fa-solid fa-cloud-upload-alt fa-3x text-red-cross mb-3"></i>
                                            <p class="mb-2">Click to upload or drag and drop</p>
                                            <p class="text-muted small">Accepted formats: JPG, PNG, PDF (Max 5MB)</p>
                                            <input type="file" id="idFile" accept="image/*,.pdf" style="display: none;">
                                        </div>
                                        <div id="idPreview" style="display: none;">
                                            <img id="idPreviewImage" class="preview-image" alt="ID Preview">
                                            <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeFile('id')">
                                                <i class="fa-solid fa-times me-1"></i>Remove
                                            </button>
                                        </div>
                                        <small class="text-danger" id="idFileError"></small>
                                    </div>

                                    <!-- Address Proof Upload -->
                                    <div class="red-cross-form-group mb-4">
                                        <label class="red-cross-form-label">
                                            <i class="fa-solid fa-home me-2"></i>
                                            Proof of Address
                                        </label>
                                        <div class="file-upload-area" id="addressUploadArea">
                                            <i class="fa-solid fa-cloud-upload-alt fa-3x text-red-cross mb-3"></i>
                                            <p class="mb-2">Click to upload or drag and drop</p>
                                            <p class="text-muted small">Accepted formats: JPG, PNG, PDF (Max 5MB)</p>
                                            <p class="text-muted small">Utility bill, bank statement, or government document</p>
                                            <input type="file" id="addressFile" accept="image/*,.pdf" style="display: none;">
                                        </div>
                                        <div id="addressPreview" style="display: none;">
                                            <img id="addressPreviewImage" class="preview-image" alt="Address Proof Preview">
                                            <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeFile('address')">
                                                <i class="fa-solid fa-times me-1"></i>Remove
                                            </button>
                                        </div>
                                        <small class="text-danger" id="addressFileError"></small>
                                    </div>

                                    <!-- Additional Information -->
                                    <div class="red-cross-form-group mb-4">
                                        <label for="additionalNotes" class="red-cross-form-label">Additional Notes (Optional)</label>
                                        <textarea class="red-cross-form-control" id="additionalNotes" rows="3" 
                                            placeholder="Any additional information you'd like to provide..."></textarea>
                                    </div>

                                    <div class="text-center">
                                        <button type="submit" class="btn-red-cross btn-lg" id="submitVerificationBtn">
                                            <i class="fa-solid fa-paper-plane me-2"></i>
                                            Submit for Verification
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Red Cross Footer -->
    <footer class="red-cross-footer">
        <div class="container">
            <div class="red-cross-footer-bottom">
                <p>&copy; 2025 BloodConnect. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase and Auth -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-storage.js";
        import authManager from './auth-manager.js';
        import bloodConnectDB from './bloodConnectDB.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAG6Drx2JJlBX1TGvLMWPHp_D2xBDTPIjI",
            authDomain: "bloodconnect-b5142.firebaseapp.com",
            databaseURL: "https://bloodconnect-b5142-default-rtdb.firebaseio.com",
            projectId: "bloodconnect-b5142",
            storageBucket: "bloodconnect-b5142.firebasestorage.app",
            messagingSenderId: "631993835929",
            appId: "1:631993835929:web:75554aca166e9058473308"
        };
        
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        
        window.firebaseStorage = storage;
        window.uploadFile = async (file, path, onProgress) => {
            try {
                console.log('Starting upload for:', path, 'File size:', file.size, 'File type:', file.type);
                
                if (!file || file.size === 0) {
                    throw new Error('Invalid file. File is empty or not selected.');
                }
                
                // Create a timeout promise (60 seconds)
                const uploadTimeout = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Upload timeout. Please check your internet connection and try again.')), 60000);
                });
                
                const storageRef = ref(storage, path);
                console.log('Storage reference created:', storageRef.fullPath);
                
                // Upload file with timeout
                const uploadPromise = uploadBytes(storageRef, file);
                const snapshot = await Promise.race([uploadPromise, uploadTimeout]);
                
                if (!snapshot) {
                    throw new Error('Upload failed. No data received.');
                }
                
                console.log('Upload completed. Bytes uploaded:', snapshot.bytesTransferred);
                
                // Get download URL with timeout
                const urlPromise = getDownloadURL(storageRef);
                const downloadURL = await Promise.race([
                    urlPromise,
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Failed to get download URL.')), 10000))
                ]);
                
                if (!downloadURL) {
                    throw new Error('Failed to get download URL after upload.');
                }
                
                console.log('Download URL obtained successfully');
                return downloadURL;
                
            } catch (error) {
                console.error('Error uploading file:', error);
                console.error('Error details:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack
                });
                
                // Provide more specific error messages
                let errorMessage = 'Failed to upload file. ';
                
                if (error.code) {
                    switch (error.code) {
                        case 'storage/unauthorized':
                            errorMessage += 'You do not have permission to upload files. Please contact support.';
                            break;
                        case 'storage/canceled':
                            errorMessage += 'Upload was canceled. Please try again.';
                            break;
                        case 'storage/unknown':
                            errorMessage += 'An unknown error occurred. Please try again.';
                            break;
                        case 'storage/invalid-argument':
                            errorMessage += 'Invalid file. Please check your file and try again.';
                            break;
                        case 'storage/quota-exceeded':
                            errorMessage += 'Storage quota exceeded. Please contact support.';
                            break;
                        default:
                            errorMessage += error.message || 'Please check your internet connection and try again.';
                    }
                } else {
                    errorMessage += error.message || 'Please check your internet connection and try again.';
                }
                
                throw new Error(errorMessage);
            }
        };
    </script>

    <script>
        let idFile = null;
        let addressFile = null;
        let currentUserId = null;
        let userData = null;

        // Check authentication and verification status
        authManager.addAuthListener(async (user, data) => {
            if (!user || !data) {
                window.location.href = 'login.html';
                return;
            }

            if (data.role !== 'donor') {
                await authManager.redirectByRole();
                return;
            }

            currentUserId = user.uid;
            userData = data;
            checkVerificationStatus();
        });

        // Handle logout button
        document.addEventListener('click', (e) => {
            if (e.target?.id === 'logoutBtn' || e.target?.closest('a[href="logout.html"]')) {
                e.preventDefault();
                authManager.logoutAndRedirect();
            }
        });

        async function checkVerificationStatus() {
            try {
                const user = await bloodConnectDB.getUser(currentUserId);
                
                if (user && user.verificationStatus) {
                    showVerificationStatus(user.verificationStatus);
                    
                    if (user.verificationStatus === 'approved') {
                        // Redirect to donor dashboard after 3 seconds
                        setTimeout(() => {
                            window.location.href = 'donor-dashboard.html';
                        }, 3000);
                    } else if (user.verificationStatus === 'pending') {
                        document.getElementById('verificationForm').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error checking verification status:', error);
            }
        }

        function showVerificationStatus(status) {
            const container = document.getElementById('verificationStatusContainer');
            const statusDiv = document.getElementById('verificationStatus');
            const statusText = document.getElementById('verificationStatusText');
            
            container.style.display = 'block';
            statusDiv.className = `verification-status ${status}`;
            
            if (status === 'pending') {
                statusText.innerHTML = '<strong>Pending Review</strong><br>Your verification documents are under review. You will be notified once the review is complete.';
            } else if (status === 'approved') {
                statusText.innerHTML = '<strong>Verified!</strong><br>Your profile has been verified. Redirecting to dashboard...';
            } else if (status === 'rejected') {
                statusText.innerHTML = '<strong>Verification Rejected</strong><br>Your verification was rejected. Please contact support or resubmit your documents.';
            }
        }

        // File upload handlers
        document.getElementById('idUploadArea').addEventListener('click', () => {
            document.getElementById('idFile').click();
        });

        document.getElementById('addressUploadArea').addEventListener('click', () => {
            document.getElementById('addressFile').click();
        });

        // Drag and drop handlers
        ['idUploadArea', 'addressUploadArea'].forEach(id => {
            const area = document.getElementById(id);
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0], id === 'idUploadArea' ? 'id' : 'address');
                }
            });
        });

        document.getElementById('idFile').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0], 'id');
            }
        });

        document.getElementById('addressFile').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0], 'address');
            }
        });

        function handleFileSelect(file, type) {
            // Validate file
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
            
            if (!allowedTypes.includes(file.type)) {
                document.getElementById(`${type}FileError`).textContent = 'Invalid file type. Please upload JPG, PNG, or PDF.';
                return;
            }
            
            if (file.size > maxSize) {
                document.getElementById(`${type}FileError`).textContent = 'File size exceeds 5MB limit.';
                return;
            }

            document.getElementById(`${type}FileError`).textContent = '';

            if (type === 'id') {
                idFile = file;
            } else {
                addressFile = file;
            }

            // Show preview for images
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById(`${type}Preview`);
                    const previewImage = document.getElementById(`${type}PreviewImage`);
                    previewImage.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                // For PDF, just show that it's selected
                const preview = document.getElementById(`${type}Preview`);
                preview.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fa-solid fa-file-pdf me-2"></i>
                        ${file.name} selected
                        <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeFile('${type}')">
                            <i class="fa-solid fa-times me-1"></i>Remove
                        </button>
                    </div>
                `;
                preview.style.display = 'block';
            }
        }

        function removeFile(type) {
            if (type === 'id') {
                idFile = null;
                document.getElementById('idFile').value = '';
                document.getElementById('idPreview').style.display = 'none';
            } else {
                addressFile = null;
                document.getElementById('addressFile').value = '';
                document.getElementById('addressPreview').style.display = 'none';
            }
        }

        // Form submission
        document.getElementById('verificationFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!idFile || !addressFile) {
                alert('Please upload both ID and address proof documents.');
                return;
            }

            const submitBtn = document.getElementById('submitVerificationBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Uploading files...';

            let idUrl = null;
            let addressUrl = null;

            try {
                // Check if uploadFile function is available
                if (!window.uploadFile) {
                    throw new Error('Upload function not available. Please refresh the page and try again.');
                }

                // Upload files to Firebase Storage one at a time with better error handling
                const idPath = `verifications/${currentUserId}/id_${Date.now()}.${idFile.name.split('.').pop()}`;
                const addressPath = `verifications/${currentUserId}/address_${Date.now()}.${addressFile.name.split('.').pop()}`;

                console.log('Uploading ID file...');
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Uploading ID document...';
                
                try {
                    idUrl = await window.uploadFile(idFile, idPath);
                    console.log('ID file uploaded successfully:', idUrl);
                } catch (error) {
                    console.error('Failed to upload ID file:', error);
                    throw new Error('Failed to upload ID document: ' + error.message);
                }

                console.log('Uploading address file...');
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Uploading address proof...';
                
                try {
                    addressUrl = await window.uploadFile(addressFile, addressPath);
                    console.log('Address file uploaded successfully:', addressUrl);
                } catch (error) {
                    console.error('Failed to upload address file:', error);
                    throw new Error('Failed to upload address proof: ' + error.message);
                }

                if (!idUrl || !addressUrl) {
                    throw new Error('File upload failed. Please try again.');
                }

                // Save verification data to Realtime Database
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Saving verification data...';
                
                const verificationData = {
                    userId: currentUserId,
                    idDocumentUrl: idUrl,
                    addressDocumentUrl: addressUrl,
                    additionalNotes: document.getElementById('additionalNotes').value,
                    verificationStatus: 'pending',
                    submittedAt: new Date().toISOString(),
                    reviewedBy: null,
                    reviewedAt: null,
                    rejectionReason: null
                };

                console.log('Updating user record...');
                // Update user record
                const updateResult = await bloodConnectDB.updateUser(currentUserId, {
                    verificationStatus: 'pending',
                    idDocumentUrl: idUrl,
                    addressDocumentUrl: addressUrl,
                    verificationSubmittedAt: new Date().toISOString()
                });

                if (!updateResult.success) {
                    throw new Error('Failed to update user record: ' + updateResult.message);
                }

                console.log('Creating verification record...');
                // Create verification record
                const verificationResult = await bloodConnectDB.createVerification(verificationData);
                
                if (!verificationResult.success) {
                    throw new Error('Failed to create verification record: ' + verificationResult.message);
                }

                // Get all admin users and notify them
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Sending notifications...';
                
                try {
                    const users = await bloodConnectDB.getUsers();
                    const adminUsers = Object.entries(users)
                        .filter(([id, user]) => user.role === 'admin')
                        .map(([id, user]) => id);

                    // Notify all admin users
                    for (const adminId of adminUsers) {
                        try {
                            await bloodConnectDB.createNotification({
                                userId: adminId,
                                type: 'verification',
                                title: 'New Donor Verification Request',
                                message: `${userData.firstName || 'A donor'} ${userData.lastName || ''} has submitted verification documents.`,
                                priority: 'high',
                                actionUrl: 'admin-donor-verifications.html',
                                relatedUserId: currentUserId,
                                status: 'pending',
                                createdAt: new Date().toISOString()
                            });
                        } catch (notifError) {
                            console.warn('Failed to notify admin:', adminId, notifError);
                            // Continue even if notification fails
                        }
                    }
                } catch (notifError) {
                    console.warn('Error creating notifications:', notifError);
                    // Continue even if notifications fail
                }

                submitBtn.innerHTML = '<i class="fa-solid fa-check me-2"></i>Success!';
                submitBtn.classList.add('btn-success');
                
                alert('Verification documents submitted successfully! Your profile will be reviewed within 24-48 hours.');
                
                // Reset form and reload status
                setTimeout(() => {
                    checkVerificationStatus();
                    submitBtn.classList.remove('btn-success');
                }, 1000);
                
            } catch (error) {
                console.error('Error submitting verification:', error);
                
                // More detailed error message
                let errorMsg = 'Error submitting verification: ';
                if (error.message) {
                    errorMsg += error.message;
                } else {
                    errorMsg += 'Please check your internet connection and try again.';
                }
                
                alert(errorMsg);
                submitBtn.innerHTML = '<i class="fa-solid fa-exclamation-triangle me-2"></i>Upload Failed - Try Again';
                submitBtn.classList.add('btn-danger');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    submitBtn.classList.remove('btn-danger');
                }, 3000);
            } finally {
                submitBtn.disabled = false;
                if (!submitBtn.classList.contains('btn-success') && !submitBtn.classList.contains('btn-danger')) {
                    submitBtn.innerHTML = '<i class="fa-solid fa-paper-plane me-2"></i>Submit for Verification';
                }
            }
        });
    </script>
</body>
</html>

