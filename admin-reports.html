<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin - Reports</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .navbar { background: #c0392b; }
        .navbar-brand, .nav-link { color: white !important; }
        .card { min-height: 180px; }
        .metric { font-size: 2rem; font-weight: 700; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
        <div class="container">
            <a class="navbar-brand" href="admin.html">Admin</a>
            <div class="collapse navbar-collapse"></div>
            <a class="nav-link text-white" href="logout.html">Logout</a>
        </div>
    </nav>

    <div class="container py-4">
        <h3 class="mb-3">Reports</h3>

        <div class="row g-3">
            <div class="col-md-3"><div class="card card-body"><div>Total Blood (L)</div><div class="metric" id="m_totalBlood">0</div></div></div>
            <div class="col-md-3"><div class="card card-body"><div>Registered Donors</div><div class="metric" id="m_donors">0</div></div></div>
            <div class="col-md-3"><div class="card card-body"><div>Pending Requests</div><div class="metric" id="m_pendingReq">0</div></div></div>
            <div class="col-md-3"><div class="card card-body"><div>Approved Requests</div><div class="metric" id="m_approvedReq">0</div></div></div>
        </div>

        <div class="mt-4">
            <h5>Requests by Status</h5>
            <div class="table-responsive">
                <table class="table table-bordered bg-white">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody id="requestsSummary"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAG6Drx2JJlBX1TGvLMWPHp_D2xBDTPIjI",
            authDomain: "bloodconnect-b5142.firebaseapp.com",
            databaseURL: "https://bloodconnect-b5142-default-rtdb.firebaseio.com",
            projectId: "bloodconnect-b5142",
            storageBucket: "bloodconnect-b5142.appspot.com",
            messagingSenderId: "631993835929",
            appId: "1:631993835929:web:75554aca166e9058473308"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        function setText(id, value) { document.getElementById(id).innerText = value; }

        function computeTotalBlood(inv) {
            let total = 0; if (!inv) return 0;
            Object.values(inv).forEach(v => { const n = parseFloat(v); if (!isNaN(n)) total += n; });
            return total.toFixed(1);
        }

        function render(inv, donors, requests) {
            setText('m_totalBlood', computeTotalBlood(inv));
            setText('m_donors', donors ? Object.keys(donors).length : 0);
            const counts = { pending: 0, approved: 0, rejected: 0 };
            Object.values(requests || {}).forEach(r => { counts[r.status || 'pending'] = (counts[r.status || 'pending']||0) + 1; });
            setText('m_pendingReq', counts.pending || 0);
            setText('m_approvedReq', counts.approved || 0);

            const tbody = document.getElementById('requestsSummary');
            tbody.innerHTML = '';
            Object.entries(counts).forEach(([status, count]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${status}</td><td>${count}</td>`;
                tbody.appendChild(tr);
            });
        }

        auth.onAuthStateChanged((user) => {
            if (!user) { window.location.href = 'login.html'; return; }
            Promise.all([
                db.ref('bloodInventory').once('value'),
                db.ref('donors').once('value'),
                db.ref('hospitalRequests').once('value')
            ]).then(([invSnap, donorsSnap, reqSnap]) => {
                render(invSnap.val(), donorsSnap.val(), reqSnap.val());
            });
        });
    </script>
</body>
</html>

