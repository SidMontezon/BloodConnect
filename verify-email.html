<!DOCTYPE html>
<html lang="en">
<head>
    <title>BloodConnect - Email Verification</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .verification-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
        }
        .verification-box { 
            background: white; 
            padding: 40px; 
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: center; 
            width: 100%; 
            max-width: 500px; 
        }
        .error-message {
            color: red;
            margin-top: 10px;
        }
        .success-message {
            color: green;
            margin-top: 10px;
        }
        .info-message {
            color: #0d6efd;
            margin-top: 10px;
        }
        .verification-icon {
            font-size: 4rem;
            color: #dc3545;
            margin-bottom: 20px;
        }
        .resend-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-dark bg-danger">
    <div class="container">
        <a class="navbar-brand" href="index.html"><i class="fa-solid fa-droplet"></i> BloodConnect</a>
    </div>
</nav>

<!-- Email Verification Form -->
<div class="verification-container">
    <div class="verification-box">
        <div class="verification-icon">
            <i class="fa-solid fa-envelope-open"></i>
        </div>
        
        <h2>Verify Your Email Address</h2>
        <p class="text-muted">We've sent a verification link to your email address. Please check your inbox and click the link to verify your account.</p>
        
        <div id="userInfo" class="mb-4">
            <p><strong>Email:</strong> <span id="userEmail"></span></p>
        </div>

        <div class="resend-section">
            <h5>Didn't receive the email?</h5>
            <p class="text-muted">Check your spam folder or click the button below to resend the verification email.</p>
            <button class="btn btn-outline-danger" onclick="resendVerificationEmail()" id="resendBtn">
                <i class="fa-solid fa-paper-plane"></i> Resend Verification Email
            </button>
            <div class="mt-2">
                <small class="text-muted" id="resendTimer"></small>
            </div>
        </div>

        <div class="mt-4">
            <button class="btn btn-success" onclick="checkEmailVerification()" id="checkVerificationBtn">
                <i class="fa-solid fa-check"></i> I've Verified My Email
            </button>
        </div>

        <!-- Back to Login -->
        <div class="mt-3">
            <a href="login.html" class="text-danger">
                <i class="fa-solid fa-arrow-left"></i> Back to Login
            </a>
        </div>

        <!-- Message Display -->
        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>
        <div class="info-message" id="info-message"></div>
    </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyBElBKqa9ThPR1TbEXlCu-wGdi0vE943O4",
        authDomain: "bloodconnect2-d094a.firebaseapp.com",
        projectId: "bloodconnect2-d094a",
        storageBucket: "bloodconnect2-d094a.firebasestorage.app",
        messagingSenderId: "124251937624",
        appId: "1:124251937624:web:a69830e6bd3ab62e66a32d"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let resendTimer = 0;
    let resendInterval = null;

    // Check if user has pending verification
    window.addEventListener('load', function() {
        const pendingVerification = sessionStorage.getItem('pendingVerification');
        if (!pendingVerification) {
            // Check if user is already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    document.getElementById('userEmail').textContent = user.email;
                    if (user.emailVerified) {
                        showSuccess('Your email is already verified!');
                        setTimeout(() => {
                            redirectToDashboard();
                        }, 2000);
                    }
                } else {
                    window.location.href = 'login.html';
                }
            });
        } else {
            const userData = JSON.parse(pendingVerification);
            document.getElementById('userEmail').textContent = userData.email;
        }
    });

    function resendVerificationEmail() {
        const pendingVerification = sessionStorage.getItem('pendingVerification');
        
        if (pendingVerification) {
            const userData = JSON.parse(pendingVerification);
            
            // Sign in the user temporarily to resend verification
            auth.signInWithEmailAndPassword(userData.email, 'temp')
                .then(() => {
                    // This will fail, but we can still send verification
                })
                .catch(() => {
                    // Expected to fail, continue with resend
                });
        }

        // Get current user
        const user = auth.currentUser;
        if (user) {
            user.sendEmailVerification()
                .then(() => {
                    showSuccess('Verification email sent successfully!');
                    startResendTimer();
                })
                .catch((error) => {
                    console.error('Error sending verification email:', error);
                    showError('Error sending verification email: ' + error.message);
                });
        } else {
            showError('Please log in again to resend verification email.');
        }
    }

    function checkEmailVerification() {
        const user = auth.currentUser;
        if (user) {
            user.reload().then(() => {
                if (user.emailVerified) {
                    showSuccess('Email verified successfully!');
                    
                    // Update user data in Firestore
                    db.collection("users").doc(user.uid).update({
                        emailVerified: true
                    }).then(() => {
                        // Clear pending verification
                        sessionStorage.removeItem('pendingVerification');
                        
                        // Redirect to appropriate dashboard
                        setTimeout(() => {
                            redirectToDashboard();
                        }, 2000);
                    }).catch((error) => {
                        console.error('Error updating user data:', error);
                        showError('Error updating user data: ' + error.message);
                    });
                } else {
                    showError('Email not verified yet. Please check your email and click the verification link.');
                }
            }).catch((error) => {
                console.error('Error reloading user:', error);
                showError('Error checking verification status: ' + error.message);
            });
        } else {
            showError('Please log in to check verification status.');
        }
    }

    function redirectToDashboard() {
        const user = auth.currentUser;
        if (user) {
            // Get user role from Firestore
            db.collection("users").doc(user.uid).get()
                .then((doc) => {
                    if (doc.exists) {
                        const role = doc.data().role;
                        if (role === "admin") {
                            window.location.href = "dashboard.html";
                        } else if (role === "user" || role === "donor") {
                            window.location.href = "donatordashboard.html";
                        } else if (role === "hospital") {
                            window.location.href = "hospitaldashboard.html";
                        } else {
                            window.location.href = "index.html";
                        }
                    } else {
                        window.location.href = "index.html";
                    }
                })
                .catch((error) => {
                    console.error('Error getting user role:', error);
                    window.location.href = "index.html";
                });
        } else {
            window.location.href = "login.html";
        }
    }

    function startResendTimer() {
        resendTimer = 60; // 60 seconds
        document.getElementById('resendBtn').disabled = true;
        
        resendInterval = setInterval(() => {
            resendTimer--;
            document.getElementById('resendTimer').textContent = `Resend available in ${resendTimer} seconds`;
            
            if (resendTimer <= 0) {
                clearInterval(resendInterval);
                document.getElementById('resendBtn').disabled = false;
                document.getElementById('resendTimer').textContent = '';
            }
        }, 1000);
    }

    function showError(message) {
        const errorElement = document.getElementById('error-message');
        const successElement = document.getElementById('success-message');
        const infoElement = document.getElementById('info-message');
        
        errorElement.textContent = message;
        successElement.textContent = '';
        infoElement.textContent = '';
        
        errorElement.style.display = 'block';
        successElement.style.display = 'none';
        infoElement.style.display = 'none';
    }

    function showSuccess(message) {
        const errorElement = document.getElementById('error-message');
        const successElement = document.getElementById('success-message');
        const infoElement = document.getElementById('info-message');
        
        successElement.textContent = message;
        errorElement.textContent = '';
        infoElement.textContent = '';
        
        successElement.style.display = 'block';
        errorElement.style.display = 'none';
        infoElement.style.display = 'none';
    }

    function showInfo(message) {
        const errorElement = document.getElementById('error-message');
        const successElement = document.getElementById('success-message');
        const infoElement = document.getElementById('info-message');
        
        infoElement.textContent = message;
        errorElement.textContent = '';
        successElement.textContent = '';
        
        infoElement.style.display = 'block';
        errorElement.style.display = 'none';
        successElement.style.display = 'none';
    }

    // Auto-check verification every 5 seconds
    setInterval(() => {
        const user = auth.currentUser;
        if (user && !user.emailVerified) {
            user.reload().then(() => {
                if (user.emailVerified) {
                    showSuccess('Email verified successfully! Redirecting...');
                    setTimeout(() => {
                        redirectToDashboard();
                    }, 2000);
                }
            }).catch((error) => {
                // Silently handle errors in auto-check
            });
        }
    }, 5000);
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
