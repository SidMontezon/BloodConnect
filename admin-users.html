<!DOCTYPE html>
<html lang="en">
<head>
    <title>BloodConnect - User Management</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .admin-container { 
            max-width: 1200px; 
            margin: 20px auto; 
            padding: 20px; 
        }
        .admin-card { 
            background: white; 
            padding: 30px; 
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .user-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        .user-card.admin { background: #fff3cd; }
        .user-card.donor { background: #d1ecf1; }
        .user-card.hospital { background: #d4edda; }
        .error-message {
            color: red;
            margin-top: 10px;
        }
        .success-message {
            color: green;
            margin-top: 10px;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status-verified { background-color: #d4edda; color: #155724; }
        .status-unverified { background-color: #f8d7da; color: #721c24; }
        .status-enabled { background-color: #d4edda; color: #155724; }
        .status-disabled { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-danger">
    <div class="container">
        <a class="navbar-brand" href="dashboard.html"><i class="fa-solid fa-droplet"></i> BloodConnect Admin</a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="dashboard.html">
                <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</nav>

<!-- Admin Panel -->
<div class="admin-container">
    <!-- Add New User Form -->
    <div class="admin-card">
        <h2><i class="fa-solid fa-user-plus"></i> Add New User</h2>
        <form id="addUserForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="userName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="userName" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="userEmail" required>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="userPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="userPassword" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="userRole" class="form-label">Role</label>
                        <select class="form-select" id="userRole" required>
                            <option value="donor">Donor</option>
                            <option value="hospital">Hospital</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="userPhone" class="form-label">Phone Number (Optional)</label>
                        <input type="tel" class="form-control" id="userPhone" placeholder="9123456789">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Options</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailVerified">
                            <label class="form-check-label" for="emailVerified">
                                Email Verified
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="twoFactorEnabled">
                            <label class="form-check-label" for="twoFactorEnabled">
                                Enable 2FA
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-danger">
                <i class="fa-solid fa-plus"></i> Add User
            </button>
        </form>
        
        <!-- Message Display -->
        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>
    </div>

    <!-- Users List -->
    <div class="admin-card">
        <h2><i class="fa-solid fa-users"></i> All Users</h2>
        <div class="mb-3">
            <input type="text" class="form-control" id="searchUsers" placeholder="Search users by name or email...">
        </div>
        <div id="usersList">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script>
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyBElBKqa9ThPR1TbEXlCu-wGdi0vE943O4",
        authDomain: "bloodconnect2-d094a.firebaseapp.com",
        projectId: "bloodconnect2-d094a",
        storageBucket: "bloodconnect2-d094a.firebasestorage.app",
        messagingSenderId: "124251937624",
        appId: "1:124251937624:web:a69830e6bd3ab62e66a32d"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let allUsers = [];

    // Check if user is admin
    window.addEventListener('load', function() {
        auth.onAuthStateChanged((user) => {
            if (user) {
                // Check if user is admin
                db.collection("users").doc(user.uid).get()
                    .then((doc) => {
                        if (doc.exists && doc.data().role === "admin") {
                            loadUsers();
                        } else {
                            showError("Access denied. Admin privileges required.");
                            setTimeout(() => {
                                window.location.href = "login.html";
                            }, 2000);
                        }
                    });
            } else {
                window.location.href = "login.html";
            }
        });
    });

    // Add user form submission
    document.getElementById("addUserForm").addEventListener("submit", function(event) {
        event.preventDefault();
        
        const name = document.getElementById("userName").value;
        const email = document.getElementById("userEmail").value;
        const password = document.getElementById("userPassword").value;
        const role = document.getElementById("userRole").value;
        const phone = document.getElementById("userPhone").value;
        const emailVerified = document.getElementById("emailVerified").checked;
        const twoFactorEnabled = document.getElementById("twoFactorEnabled").checked;

        // Create user with Firebase Auth
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;
                
                // Update user profile
                user.updateProfile({
                    displayName: name
                });

                // Set email verification status
                if (emailVerified) {
                    user.sendEmailVerification().then(() => {
                        // Email verification sent, but we'll mark as verified in Firestore
                    });
                }

                // Save user data to Firestore
                const userData = {
                    name: name,
                    email: email,
                    role: role,
                    emailVerified: emailVerified,
                    twoFactorEnabled: twoFactorEnabled,
                    phoneNumber: phone ? '+63' + phone : '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: auth.currentUser.uid
                };

                return db.collection("users").doc(user.uid).set(userData);
            })
            .then(() => {
                showSuccess("User created successfully!");
                document.getElementById("addUserForm").reset();
                loadUsers(); // Refresh the users list
            })
            .catch((error) => {
                console.error("Error creating user:", error);
                showError("Error creating user: " + error.message);
            });
    });

    // Load all users
    function loadUsers() {
        db.collection("users").orderBy("createdAt", "desc").get()
            .then((querySnapshot) => {
                allUsers = [];
                querySnapshot.forEach((doc) => {
                    allUsers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                displayUsers(allUsers);
            })
            .catch((error) => {
                console.error("Error loading users:", error);
                showError("Error loading users: " + error.message);
            });
    }

    // Display users
    function displayUsers(users) {
        const usersList = document.getElementById("usersList");
        
        if (users.length === 0) {
            usersList.innerHTML = '<div class="text-center text-muted">No users found</div>';
            return;
        }

        usersList.innerHTML = users.map(user => `
            <div class="user-card ${user.role}">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h6 class="mb-1">${user.name}</h6>
                        <small class="text-muted">${user.email}</small>
                    </div>
                    <div class="col-md-2">
                        <span class="badge bg-${getRoleColor(user.role)}">${user.role.toUpperCase()}</span>
                    </div>
                    <div class="col-md-2">
                        <span class="status-badge ${user.emailVerified ? 'status-verified' : 'status-unverified'}">
                            ${user.emailVerified ? 'Verified' : 'Unverified'}
                        </span>
                    </div>
                    <div class="col-md-2">
                        <span class="status-badge ${user.twoFactorEnabled ? 'status-enabled' : 'status-disabled'}">
                            ${user.twoFactorEnabled ? '2FA On' : '2FA Off'}
                        </span>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">
                            ${user.phoneNumber || 'No phone'}
                        </small>
                    </div>
                    <div class="col-md-1">
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}')">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // Get role color
    function getRoleColor(role) {
        switch(role) {
            case 'admin': return 'danger';
            case 'hospital': return 'success';
            case 'donor': return 'primary';
            default: return 'secondary';
        }
    }

    // Delete user
    function deleteUser(userId) {
        if (confirm("Are you sure you want to delete this user? This action cannot be undone.")) {
            // Delete from Firestore
            db.collection("users").doc(userId).delete()
                .then(() => {
                    showSuccess("User deleted successfully!");
                    loadUsers(); // Refresh the list
                })
                .catch((error) => {
                    console.error("Error deleting user:", error);
                    showError("Error deleting user: " + error.message);
                });
        }
    }

    // Search users
    document.getElementById("searchUsers").addEventListener("input", function(event) {
        const searchTerm = event.target.value.toLowerCase();
        const filteredUsers = allUsers.filter(user => 
            user.name.toLowerCase().includes(searchTerm) || 
            user.email.toLowerCase().includes(searchTerm)
        );
        displayUsers(filteredUsers);
    });

    function showError(message) {
        const errorElement = document.getElementById('error-message');
        const successElement = document.getElementById('success-message');
        errorElement.textContent = message;
        successElement.textContent = '';
        errorElement.style.display = 'block';
        successElement.style.display = 'none';
    }

    function showSuccess(message) {
        const errorElement = document.getElementById('error-message');
        const successElement = document.getElementById('success-message');
        successElement.textContent = message;
        errorElement.textContent = '';
        successElement.style.display = 'block';
        errorElement.style.display = 'none';
    }
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
