<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Profile - Donor Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="red-cross-styles.css">
    <script type="module" src="auth-manager.js"></script>
    <script type="module" src="bloodConnectDB.js"></script>
</head>
<body>
    <!-- Red Cross Header -->
    <header class="red-cross-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <a href="donor-dashboard.html" class="red-cross-logo">
                    <div class="red-cross-icon">âœš</div>
                    <div>
                        <h1 class="red-cross-brand">BloodConnect</h1>
                        <p class="red-cross-tagline">Medical Blood Management</p>
                    </div>
                </a>
                <div class="red-cross-nav">
                    <a href="donor-dashboard.html">Dashboard</a>
                    <a href="donate.html">Schedule Donation</a>
                    <a href="donor-profile.html" class="active">Profile</a>
                    <a href="donor-history.html">History</a>
                    <button id="logoutBtn" class="btn-red-cross-outline" style="border:none; background:transparent; cursor:pointer;">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Page Hero -->
    <section class="red-cross-hero">
        <div class="container">
            <div class="red-cross-page-header">
                <div class="text-center">
                    <h1 class="red-cross-page-title">My Profile</h1>
                    <p class="red-cross-page-subtitle">Update your personal and medical information</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Profile Form -->
    <section class="py-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="red-cross-card">
                        <div class="red-cross-card-header">
                            <i class="fa-solid fa-user text-red-cross"></i>
                            Personal Information
                        </div>
                        <div class="red-cross-card-body">
                            <form id="profileForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="firstName" class="form-label">First Name *</label>
                                        <input type="text" class="form-control" id="firstName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="lastName" class="form-label">Last Name *</label>
                                        <input type="text" class="form-control" id="lastName" required>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">Email Address *</label>
                                        <input type="email" class="form-control" id="email" required readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="phone" class="form-label">Phone Number *</label>
                                        <input type="tel" class="form-control" id="phone" required>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="dateOfBirth" class="form-label">Date of Birth *</label>
                                        <input type="date" class="form-control" id="dateOfBirth" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="gender" class="form-label">Gender *</label>
                                        <select class="form-control" id="gender" required>
                                            <option value="">Select Gender</option>
                                            <option value="Male">Male</option>
                                            <option value="Female">Female</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="bloodType" class="form-label">Blood Type *</label>
                                        <select class="form-control" id="bloodType" required>
                                            <option value="">Select Blood Type</option>
                                            <option value="O+">O+</option>
                                            <option value="O-">O-</option>
                                            <option value="A+">A+</option>
                                            <option value="A-">A-</option>
                                            <option value="B+">B+</option>
                                            <option value="B-">B-</option>
                                            <option value="AB+">AB+</option>
                                            <option value="AB-">AB-</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="weight" class="form-label">Weight (kg) *</label>
                                        <input type="number" class="form-control" id="weight" min="40" required>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <h5 class="mb-3">Address Information</h5>

                                <div class="mb-3">
                                    <label for="address" class="form-label">Street Address *</label>
                                    <input type="text" class="form-control" id="address" required>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="city" class="form-label">City *</label>
                                        <input type="text" class="form-control" id="city" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="state" class="form-label">State/Province *</label>
                                        <input type="text" class="form-control" id="state" required>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="zipCode" class="form-label">ZIP/Postal Code *</label>
                                        <input type="text" class="form-control" id="zipCode" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="country" class="form-label">Country *</label>
                                        <input type="text" class="form-control" id="country" required>
                                    </div>
                                </div>

                                <hr class="my-4">

                                <h5 class="mb-3">Medical History</h5>

                                <div class="mb-3">
                                    <label for="medicalConditions" class="form-label">Medical Conditions</label>
                                    <textarea class="form-control" id="medicalConditions" rows="3" placeholder="List any relevant medical conditions..."></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="medications" class="form-label">Current Medications</label>
                                    <textarea class="form-control" id="medications" rows="3" placeholder="List any current medications..."></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="allergies" class="form-label">Allergies</label>
                                    <textarea class="form-control" id="allergies" rows="3" placeholder="List any allergies..."></textarea>
                                </div>

                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="donor-dashboard.html" class="btn btn-secondary">Cancel</a>
                                    <button type="submit" class="btn-red-cross">Save Profile</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Red Cross Footer -->
    <footer class="red-cross-footer">
        <div class="container">
            <div class="red-cross-footer-bottom">
                <p>&copy; 2025 BloodConnect. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import authManager from './auth-manager.js';
        import bloodConnectDB from './bloodConnectDB.js';

        let currentUserId = null;
        let currentUserData = null;

        authManager.addAuthListener(async (user, userData) => {
            if (user) {
                currentUserId = user.uid;
                currentUserData = userData;
                loadProfile(userData);
            }
        });

        function loadProfile(userData) {
            document.getElementById('firstName').value = userData.firstName || '';
            document.getElementById('lastName').value = userData.lastName || '';
            document.getElementById('email').value = userData.email || '';
            document.getElementById('phone').value = userData.phone || '';
            document.getElementById('dateOfBirth').value = userData.dateOfBirth || '';
            document.getElementById('gender').value = userData.gender || '';
            document.getElementById('bloodType').value = userData.bloodType || '';
            document.getElementById('weight').value = userData.weight || '';
            document.getElementById('address').value = userData.address || '';
            document.getElementById('city').value = userData.city || '';
            document.getElementById('state').value = userData.state || '';
            document.getElementById('zipCode').value = userData.zipCode || '';
            document.getElementById('country').value = userData.country || '';
            document.getElementById('medicalConditions').value = userData.medicalConditions || '';
            document.getElementById('medications').value = userData.medications || '';
            document.getElementById('allergies').value = userData.allergies || '';

            document.getElementById('profileForm').addEventListener('submit', submitProfile);
        }

        async function submitProfile(e) {
            e.preventDefault();

            const profileData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                phone: document.getElementById('phone').value,
                dateOfBirth: document.getElementById('dateOfBirth').value,
                gender: document.getElementById('gender').value,
                bloodType: document.getElementById('bloodType').value,
                weight: parseInt(document.getElementById('weight').value),
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                zipCode: document.getElementById('zipCode').value,
                country: document.getElementById('country').value,
                medicalConditions: document.getElementById('medicalConditions').value,
                medications: document.getElementById('medications').value,
                allergies: document.getElementById('allergies').value,
                updatedAt: new Date().toISOString()
            };

            try {
                const result = await bloodConnectDB.updateUser(currentUserId, profileData);
                if (result.success) {
                    alert('Profile updated successfully!');
                } else {
                    alert('Error updating profile: ' + result.message);
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('An error occurred while updating your profile.');
            }
        }

        // Handle logout button
        document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'logoutBtn') {
                e.preventDefault();
                authManager.logoutAndRedirect();
            }
        });
    </script>
</body>
</html>