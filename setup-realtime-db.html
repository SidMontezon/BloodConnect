<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BloodConnect - Realtime Database Setup</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="red-cross-styles.css">
    <style>
        .setup-step {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .step-number {
            background-color: #dc3545;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-weight: bold;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }
        .success-check {
            color: #28a745;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <!-- Red Cross Header -->
    <header class="red-cross-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <a href="index.html" class="red-cross-logo">
                    <div class="red-cross-icon">✚</div>
                    <div>
                        <h1 class="red-cross-brand">BloodConnect</h1>
                        <p class="red-cross-tagline">Realtime Database Setup</p>
                    </div>
                </a>
                <div class="red-cross-nav">
                    <a href="index.html">Home</a>
                    <a href="test-realtime-db.html">Test Database</a>
                    <a href="admin.html">Admin</a>
                </div>
            </div>
        </div>
    </header>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2 class="text-center mb-4">
                    <i class="fa-solid fa-database text-red-cross"></i>
                    Firebase Realtime Database Setup Guide
                </h2>
                <p class="text-center text-muted">
                    Follow these steps to set up and configure Firebase Realtime Database for your BloodConnect system.
                </p>
            </div>
        </div>

        <!-- Step 1: Database Connection Test -->
        <div class="setup-step">
            <h4>
                <span class="step-number">1</span>
                Test Database Connection
            </h4>
            <p>First, let's verify that your Firebase Realtime Database is properly configured and accessible.</p>
            <button class="btn btn-primary" onclick="testDatabaseConnection()">
                <i class="fa-solid fa-plug"></i> Test Connection
            </button>
            <div id="connectionStatus" class="mt-3" style="display: none;"></div>
        </div>

        <!-- Step 2: Add Sample Data -->
        <div class="setup-step">
            <h4>
                <span class="step-number">2</span>
                Add Sample Data
            </h4>
            <p>Populate your database with sample data to test functionality and see how the system works.</p>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-success w-100" onclick="addSampleData()">
                        <i class="fa-solid fa-plus"></i> Add Sample Data
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-warning w-100" onclick="clearAllData()">
                        <i class="fa-solid fa-trash"></i> Clear All Data
                    </button>
                </div>
            </div>
            <div id="sampleDataStatus" class="mt-3" style="display: none;"></div>
        </div>

        <!-- Step 3: Verify Data Structure -->
        <div class="setup-step">
            <h4>
                <span class="step-number">3</span>
                Verify Database Structure
            </h4>
            <p>Check that all database collections and data are properly structured.</p>
            <button class="btn btn-info" onclick="verifyDatabaseStructure()">
                <i class="fa-solid fa-check-circle"></i> Verify Structure
            </button>
            <div id="structureStatus" class="mt-3" style="display: none;"></div>
        </div>

        <!-- Step 4: Test Real-time Features -->
        <div class="setup-step">
            <h4>
                <span class="step-number">4</span>
                Test Real-time Features
            </h4>
            <p>Verify that real-time updates are working correctly across all collections.</p>
            <button class="btn btn-purple" onclick="testRealtimeFeatures()">
                <i class="fa-solid fa-broadcast-tower"></i> Test Real-time Updates
            </button>
            <div id="realtimeStatus" class="mt-3" style="display: none;"></div>
        </div>

        <!-- Step 5: Integration Test -->
        <div class="setup-step">
            <h4>
                <span class="step-number">5</span>
                Test System Integration
            </h4>
            <p>Verify that the realtime database integrates properly with your existing authentication system.</p>
            <button class="btn btn-dark" onclick="testSystemIntegration()">
                <i class="fa-solid fa-cogs"></i> Test Integration
            </button>
            <div id="integrationStatus" class="mt-3" style="display: none;"></div>
        </div>

        <!-- Setup Complete -->
        <div class="setup-step" id="setupComplete" style="display: none;">
            <h4>
                <i class="fa-solid fa-check-circle success-check"></i>
                Setup Complete!
            </h4>
            <p>Your Firebase Realtime Database is now fully configured and ready to use.</p>
            <div class="row">
                <div class="col-md-4">
                    <a href="test-realtime-db.html" class="btn btn-primary w-100">
                        <i class="fa-solid fa-flask"></i> Test Database
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="admin.html" class="btn btn-success w-100">
                        <i class="fa-solid fa-user-shield"></i> Admin Panel
                    </a>
                </div>
                <div class="col-md-4">
                    <a href="dashboard.html" class="btn btn-info w-100">
                        <i class="fa-solid fa-tachometer-alt"></i> Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Quick Reference -->
        <div class="setup-step">
            <h4>
                <i class="fa-solid fa-book text-primary"></i>
                Quick Reference
            </h4>
            <p>Here are the key files and functions you can use in your BloodConnect system:</p>
            
            <h6>Key Files:</h6>
            <ul>
                <li><code>firebase-realtime.js</code> - Main database operations</li>
                <li><code>firebase-integration.js</code> - Authentication integration</li>
                <li><code>database-schema.js</code> - Database structure definition</li>
                <li><code>add-sample-data.js</code> - Sample data management</li>
            </ul>

            <h6>Key Functions:</h6>
            <div class="code-block">
// Create user
await bloodConnectDB.createUser(userId, userData);

// Add blood inventory
await bloodConnectDB.addBloodInventory(inventoryData);

// Create blood request
await bloodConnectDB.createBloodRequest(requestData);

// Listen to real-time updates
const unsubscribe = bloodConnectDB.listenToBloodInventory(callback);

// Search and filter
const results = await bloodConnectDB.searchBloodByType("O+");
            </div>

            <h6>Database Collections:</h6>
            <ul>
                <li><code>/users</code> - User accounts and profiles</li>
                <li><code>/bloodInventory</code> - Blood inventory management</li>
                <li><code>/bloodRequests</code> - Blood requests and orders</li>
                <li><code>/donations</code> - Blood donation records</li>
                <li><code>/hospitals</code> - Hospital and clinic information</li>
                <li><code>/notifications</code> - System notifications</li>
            </ul>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase Scripts -->
    <script type="module" src="firebase-realtime.js"></script>
    <script type="module" src="firebase-integration.js"></script>
    <script type="module" src="database-schema.js"></script>
    <script type="module" src="add-sample-data.js"></script>

    <script>
        let setupProgress = 0;
        const totalSteps = 5;

        function updateProgress() {
            setupProgress++;
            if (setupProgress >= totalSteps) {
                document.getElementById('setupComplete').style.display = 'block';
            }
        }

        function showStatus(elementId, message, isSuccess = true) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.style.display = 'block';
            statusDiv.className = `alert ${isSuccess ? 'alert-success' : 'alert-danger'}`;
            statusDiv.innerHTML = `<i class="fa-solid ${isSuccess ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> ${message}`;
        }

        async function testDatabaseConnection() {
            showStatus('connectionStatus', '<i class="fa-solid fa-spinner fa-spin"></i> Testing connection...', true);
            
            try {
                // Test basic database operations
                const testData = { test: 'connection', timestamp: new Date().toISOString() };
                await bloodConnectDB.createUser('test-connection', testData);
                
                const userData = await bloodConnectDB.getUser('test-connection');
                
                if (userData && userData.test === 'connection') {
                    showStatus('connectionStatus', 'Database connection successful! ✅', true);
                    updateProgress();
                } else {
                    throw new Error('Data verification failed');
                }
            } catch (error) {
                showStatus('connectionStatus', `Connection failed: ${error.message} ❌`, false);
            }
        }

        async function addSampleData() {
            showStatus('sampleDataStatus', '<i class="fa-solid fa-spinner fa-spin"></i> Adding sample data...', true);
            
            try {
                const result = await window.addSampleData();
                if (result.success) {
                    showStatus('sampleDataStatus', 'Sample data added successfully! ✅', true);
                    updateProgress();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showStatus('sampleDataStatus', `Error: ${error.message} ❌`, false);
            }
        }

        async function clearAllData() {
            if (!confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                return;
            }
            
            showStatus('sampleDataStatus', '<i class="fa-solid fa-spinner fa-spin"></i> Clearing data...', true);
            
            try {
                const result = await window.clearAllData();
                if (result.success) {
                    showStatus('sampleDataStatus', 'All data cleared successfully! ✅', true);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showStatus('sampleDataStatus', `Error: ${error.message} ❌`, false);
            }
        }

        async function verifyDatabaseStructure() {
            showStatus('structureStatus', '<i class="fa-solid fa-spinner fa-spin"></i> Verifying database structure...', true);
            
            try {
                const [inventory, requests, donations, hospitals] = await Promise.all([
                    bloodConnectDB.getBloodInventory(),
                    bloodConnectDB.getBloodRequests(),
                    bloodConnectDB.getDonations(),
                    bloodConnectDB.getHospitals()
                ]);

                const structureValid = 
                    Object.keys(inventory).length > 0 &&
                    Object.keys(requests).length > 0 &&
                    Object.keys(donations).length > 0 &&
                    Object.keys(hospitals).length > 0;

                if (structureValid) {
                    showStatus('structureStatus', 'Database structure verified successfully! ✅', true);
                    updateProgress();
                } else {
                    throw new Error('Database structure incomplete');
                }
            } catch (error) {
                showStatus('structureStatus', `Structure verification failed: ${error.message} ❌`, false);
            }
        }

        async function testRealtimeFeatures() {
            showStatus('realtimeStatus', '<i class="fa-solid fa-spinner fa-spin"></i> Testing real-time features...', true);
            
            try {
                let realtimeTestPassed = false;
                
                // Test real-time listener
                const unsubscribe = bloodConnectDB.listenToBloodInventory((data) => {
                    if (data && Object.keys(data).length > 0) {
                        realtimeTestPassed = true;
                        unsubscribe();
                        showStatus('realtimeStatus', 'Real-time features working correctly! ✅', true);
                        updateProgress();
                    }
                });

                // Timeout after 5 seconds
                setTimeout(() => {
                    if (!realtimeTestPassed) {
                        unsubscribe();
                        showStatus('realtimeStatus', 'Real-time test timeout. Please try again. ⚠️', false);
                    }
                }, 5000);

            } catch (error) {
                showStatus('realtimeStatus', `Real-time test failed: ${error.message} ❌`, false);
            }
        }

        async function testSystemIntegration() {
            showStatus('integrationStatus', '<i class="fa-solid fa-spinner fa-spin"></i> Testing system integration...', true);
            
            try {
                // Test if BloodConnectUtils is available
                if (window.BloodConnectUtils) {
                    const userData = await BloodConnectUtils.getCurrentUserData();
                    showStatus('integrationStatus', 'System integration successful! ✅', true);
                    updateProgress();
                } else {
                    throw new Error('BloodConnectUtils not available');
                }
            } catch (error) {
                showStatus('integrationStatus', `Integration test failed: ${error.message} ❌`, false);
            }
        }
    </script>
</body>
</html>
